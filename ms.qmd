---
title: "Effects of prenatal CORT and temperature on the response to a stressor"
format:
  docx: 
    bibliography: "./bib/refs.bib"
    csl: "./bib/animal-behaviour.csl"
    reference-doc: "./bib/tmpl.docx"
execute:
  echo: false
  error: false
  cache: false
  warning: false
link-citations: true
crossref:  
  fig-title: Fig    # (default is "Figure")
  title-delim: —     # (default is ":")
  fig-prefix: Fig.   # (default is "Figure")
  tbl-prefix: Table  # (default is "Table")
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
pacman::p_load(tidyverse, flextable, emmeans, DHARMa, brms, here, ggplot2, lme4, zoo, lmerTest, broom, tidybayes, ggh4x, cowplot, fitdistrplus, MASS, goftest, forcats, nortest, fitdistrplus, ggh4x, PupillometryR, png, grid, remotes, ggthemes, bayestestR, HDInterval, DiagrammeR, magick)
```

```{r, cleandata}
#| label: cleandata
# Obtain the main df using "./R/1_data_process.R"
source(here("R", "data_process.R"))
```

```{r, sampleSize}
#| label: sampleSize
# List with the sample sizes from the main database.
source(here("R", "func.R"))
#
species <- c("delicata", "guichenoti")
trt <- c("Control-Cold", "CORT-Cold", "Control-Hot", "CORT-Hot")
#
# Loop over species
for (s in species) {
  n_list <- list() 
  
  data_n <- mass_clean %>% 
    filter(species == s)

  for (k in trt) {
    list_name <- paste0(k)
    group_data <- data_n %>% filter(trt == k)
    n_list[[list_name]] <- nrow(group_data)
    }
  assign(paste0("n_list_", s), n_list)
}
```

```{r, countclutches}
#| label: countclutches
# Count the number of clutches per species
#
clutches <- mass_clean %>% 
  distinct(clutch) %>% 
  nrow()
```


## Introduction

Hypothesis PRESENTATION:

Both temperature and CORT influence the development of proactive-reactive personality types, associated at the same time with different HPA axis reactivity. In this sense, both increases in prenatal CORT and lower temperatures are related to more reactive individuals, which are more sensitive to stressors. As such, I predict individuals incubated at low temperature and/or treated with CORT to be more reactive, and thus to spent more time frozen after chasing them and not coming out from the shelter. At the same time I expect these individuals to have increased phisiological costs (mass lost) when submitted to a 'chronic' stressor.


## Methods

### Subjects

We used two species of skinks, the delicate skink (_Lampropholis delicata_) and the common garden skink (_L. guichenoti_). These are oviparous, generalist, small (∼35--55 mm snout-vent length (SVL)) lizards that are sympatric in suburban areas throughout south-eastern Australia ([@chapple_know_2011]). Both species have similar breeding periods, but reproductive output in *L. delicata* is one clutch of 1 to 6 eggs per season, while *L. guichenoti* lays 1-5 eggs per clutch, and usually two clutches per season ([@chapple_know_2011]; [@chapple_biology_2014]). **This difference in reproductive output through the breeding season may involve different degree of sensitivity to maternal effects and its interaction with other aspects of early environment.**

### Subjects treatments, collection, and housing

*Breeding colony* - Lizards came from a breeding colony established in the laboratory since 2019. This colony consisted of 270 adults of _L. delicata_ and 180 adults of _L. guichenoti_ housed in plastic containers (41.5 L x 30.5 W x 21 H cm) with two males and four females per enclosure. Enclosures were provided with shelter, nonstick matting, and several small water dishes. The lizards were given water daily and were fed approx. 40 mid-size crickets (_Acheta domestica_) per enclosure three days a week. The crickets were dusted with calcium weekly and multivitamin and calcium biweekly. Room temperature was set to 22-24 ºC, but we also provided the enclosures with a heat chord and a heat lamp following a 12 h light:12 h dark cycle keeping warm side of enclosures at 34 ºC.

*Eggs collection and incubation* - Eggs were collected between mid-October 2022 to the end of February 2023. We placed a small box (12.5 L x 8.3 W x 5 H cm) with moist vermiculite in one side of the communal enclosures to provide females with a place to lay the eggs. These boxes were checked three days a week. After egg collection, we measured length and width with a digital caliper to the nearest 0.1 mm and weighted the eggs with a (OHAUS, Model spx123) digital scale with an accuracy of ± 0.001 g error. Then eggs were treated with CORT or vehicle (see CORT and temperature manipulation below) and were placed in individual cups (80 mL) with moist vermiculite (12 parts water to 4 parts vermiculite). The cups were covered with cling wrap to retain moisture and left in two incubators at two different temperatures (see CORT and temperature manipulation below) until hatching.

*Hatchlings* - Incubators were checked three times a week for hatchlings. Lizards were measured and weighed immediately after hatching. Snout-vent length (SVL) and tail length (TL) were measured to the nearest millimeter, and weight was recorded using a (OHAUS, Model spx123) digital scale with an accuracy of ± 0.001 g. Hatchlings were then placed in individual enclosures (18.7L x 13.2W x 6.3H cm) with nonstick matting and a small water dish.  All care otherwise follows similar protocols to adults (see above).  
 
#### CORT and Temperature manipulation

To test the interactive effects of CORT and incubation temperature, we manipulated CORT concentrations in eggs and incubated them at cold (23 ± 3 ºC) or hot (28 ± 3 ºC) conditions (see @fig-Methods A). We used a partial split clutch design where eggs from a given clutch were distributed equally across the four treatments when clutch sizes were larger than four and randomly across treatments when less than four. Eggs were topically supplied with either 5 µL of crystalline corticosterone (Sigma, Cat. No. C2505) dissolved in 100% ethanol at a final 10 pg CORT/mL concentration (CORT treatment), or an equal volume of 100% Ethanol (Control treatment). We selected doses based on our previous study where CORT treatment increased mean yolk CORT levels by approximately 2 standard deviations above the mean natural concentration [@crino2024eggs]. Mean incubation temperatures represent the lower and upper limits of the natural range of nest temperatures in _L. delicata_ [mean nesting temperatures = 27.4 ºC; @cheetham2011embryonic]. Nonetheless, the higher temperature treatment (28 ºC) was above the thermal optima estimated for _L. delicata_ [T~opt~ = 25 ºC; @pettersen2023maternal] and reached more stressful temperatures daily as fluctuations occurred (i.e., 31 ºC).    

#### Response to acute and long-term stressors     

Three weeks before the start of the behavioural tests, we adapted the lizard enclosures to the experimental setup. The enclosures used for the stress response trials were the same as those where the lizards had previously been housed, but modified to include only a single shelter (9 × 6 × 1.5 cm) placed at one end and a water dish in the centre. All other shelter materials and the matting substrate were removed to allow continuous monitoring. The enclosures were then relocated to the experimental rooms, each containing six racks equipped with their own CCTV system (model DVR-HP210475). The number of lizards per treatment was counterbalanced across racks to control for potential effects of room or rack position. In these three weeks, lizards were fed one calcium- and multivitamin-dusted cricket per day, and water was provided _ad libitum_. A temperature gradient was maintained using heat cords and heat lamps on a 12:12 h light–dark cycle, with room temperatures kept between 22–24 °C.          

To test the effects of prenatal conditions on the response to a stressor, we simulated a predatory attack once daily over multiple days [**insert relevant reference here**]. _The simulated attack involved chasing the lizard for 60 seconds using a soft paintbrush, after which its behaviour was recorded for one hour._ **DETAILS OF EACH TRIAL**. All videos were later analysed by **MATHEO**, who was blinded to the lizards’ treatment groups. From each video, we recorded three behavioural variables: i) latency to move — the time spent immobile (frozen) immediately after the simulated attack; ii) latency to shelter — the time it took the lizard to hide under the shelter after resuming movement; and iii) emergence — whether the lizard emerged from the shelter during the 40 minutes following hiding (1 = emerged, 0 = did not emerge). A lizard was considered to have resumed movement if it moved continuously for at least five seconds, and to be under shelter if no limbs were visible. This procedure was repeated daily for eight consecutive days to assess the effects of mid-term exposure to a stressor. All trials were conducted between 1000–1400 h, when lizards are most active.

Lizard mass was measured to the nearest 0.001 g using a digital scale (OHAUS, model SPX123) both before and after the completion of the behavioural tests. Change in mass was calculated as the difference between final and initial mass and then rescaled by subtracting the smallest mass change observed in the dataset, to avoid negative values. This rescaled change in mass was used as a proxy for the physiological cost of repeated stress exposure. To control for hunger levels and potential effects of food ingestion on mass change, we also recorded the number of crickets ingested by each lizard during the acclimation period. To do so, we placed a known number of crickets in each enclosure after each of the trials, and counted the number of crickets remaining after 24 hours. The total number of crickets ingested during the eight days of tests was then used as a covariate in the analyses of mass change. The experimental design is summarised in @fig-Methods B.          
  
```{r, fig-Methods}
#| label: fig-Methods
#| fig.cap: ""

knitr::include_graphics("./Others/Methods.png")

```

### Statistical analyses

## Results

```{r, models_behaviour}
#| label: models_behaviour
source(here("R", "func.R"))
#
refit <- TRUE
#
# A) L. delicata
deli_beh <- behav_clean %>% 
  filter(species == "delicata") %>%
  mutate(lat_move = lat_move + 1, 
         lat_shelter = lat_shelter + 1)
#
deli_move <- fit_m(df = deli_beh, fam = lognormal(), type = "beh", sp = "deli", var = "lat_move")
deli_shelter <- fit_m(df = deli_beh, fam = lognormal(), type = "beh", sp = "deli", var = "lat_shelter")
deli_emergence <- fit_m(df = deli_beh, fam = bernoulli(link = "logit"), type = "beh", sp = "deli", var = "emergence")
#
#
# B) L. guichenoti
guich_beh <- behav_clean %>%
  filter(species == "guichenoti") %>%
  mutate(lat_move = lat_move + 1, 
         lat_shelter = lat_shelter + 1)
#
guich_move <- fit_m(df = guich_beh, fam = lognormal(), type = "beh", sp = "guich", var = "lat_move")
guich_shelter <- fit_m(df = guich_beh, fam = lognormal(), type = "beh", sp = "guich", var = "lat_shelter")
guich_emergence <- fit_m(df = guich_beh, fam = bernoulli(link = "logit"), type = "beh", sp = "guich", var = "emergence")
```

```{r, models_mass}
#| label: models_mass
source(here("R", "func.R"))
#
refit <- TRUE
#
# A) L. delicata
deli_mass <- mass_clean %>%
  filter(species == "delicata")
#
deli_mass <- fit_m(df = deli_mass, fam = lognormal(), type = "mass", sp = "deli", var = "delta_mass_rescaled")
# 
#
# B) L. guichenoti
guich_mass <- mass_clean %>%
  filter(species == "guichenoti")
#
guich_mass <- fit_m(df = guich_mass, fam = lognormal(), type = "mass", sp = "guich", var = "delta_mass_rescaled")
```

```{r, clean_posteriors}
#| label: clean_posteriors
source(here("R", "func.R"))
#
variables <- c("move", "shelter", "emergence", "mass")
species <- c("deli", "guich")
# Initialize empty lists
posterior_list <- list(deli = list(), guich = list())
# Loop over species and variables
for(i in species){
  for(j in variables){
    model_object <- get(paste0(i, "_", j))
    result <- tidy_post(df = model_object)
    posterior_list[[i]][[j]] <- result
  }
}
#
deli_post <- dplyr::bind_rows(posterior_list$deli, .id = "variable")
guich_post <- dplyr::bind_rows(posterior_list$guich, .id = "variable")
```






```{r, plotsMass}
#| label: plotsMass
#| echo: false
#| warning: false
 
# Plot delta Mass L. delicata
plot_deli <- ggplot(deli_stressor_2, aes(x = food_ingested, y = rescaled_delta_mass, color=interaction(cort,temp))) +  
  stat_smooth(method = "glm", formula = y ~ x, se = TRUE, linewidth=2, alpha = 0.1) +
  scale_color_manual(values = c("CORT.Cold"="black", "Control.Cold"="grey", "CORT.Hot"="orange2", "Control.Hot"="moccasin"),
    labels=c("CORT-Cold (n=12)", "Control-Cold (n=12)", "CORT-Hot (n=11)", "Control-Hot (n=12)")
  ) +
  labs(y = "Increase in mass (mg)", x = "Ingestion rate (n items)", color="Treatment") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 18, family = "sans"),  
    axis.text = element_text(size = 10, family = "sans"),  
    legend.title = element_text(size = 14, family = "sans"), 
    legend.text = element_text(size = 12, family = "sans")  
  )
print(plot_deli)
ggsave("./output/figures/fig_deli_Mass.png", plot=plot_deli, width = 18, height = 9, units = "cm", dpi = 3000)
# Plot delta Mass L. guichenoti
plot_guich <- ggplot(guich_stressor_2, aes(x = food_ingested, y = rescaled_delta_mass, color=interaction(cort,temp))) +  
  stat_smooth(method = "glm", formula = y ~ x, se = TRUE, linewidth=2, alpha = 0.1) +
  scale_color_manual(values = c("CORT.Cold"="black", "Control.Cold"="grey", "CORT.Hot"="orange2", "Control.Hot"="moccasin"),
    labels=c("CORT-Cold (n=10)", "Control-Cold (n=7)", "CORT-Hot (n=11)", "Control-Hot (n=10)")
  ) +
  labs(y = "Increase in mass (mg)", x = "Ingestion rate (n items)", color="Treatment") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 18, family = "sans"),  
    axis.text = element_text(size = 10, family = "sans"),  
    legend.title = element_text(size = 14, family = "sans"), 
    legend.text = element_text(size = 12, family = "sans")  
  )
print(plot_guich)
ggsave("./output/figures/fig_guich_Mass.png", plot=plot_guich, width = 18, height = 9, units = "cm", dpi = 3000)
```

 ```{r, plotsFrozenbehaviour}
#| label: plotsFrozenbehaviour
#| echo: false
#| warning: false

# Plot time frozen L. delicata
plot_deli_BEH <- ggplot(deli_stressor, aes(x = Day, y = log(lat_to_move+1), fill=interaction(cort,temp))) +  
  geom_boxplot(outlier.shape = NA) +
  ylim(0, 10) +
  scale_fill_manual(values = c("CORT.Cold"="black", "Control.Cold"="grey", "CORT.Hot"="orange2", "Control.Hot"="moccasin"),
    labels=c("CORT-Cold (n=12)", "Control-Cold (n=12)", "CORT-Hot (n=11)", "Control-Hot (n=12)")
  ) +
  labs(y = "Time frozen (log-transformed)", x = "Day", fill="Treatment") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 18, family = "sans"),  
    axis.text = element_text(size = 12, family = "sans"),  
    legend.title = element_text(size = 14, family = "sans"), 
    legend.text = element_text(size = 12, family = "sans")  
  )
print(plot_deli_BEH)
ggsave("./output/figures/fig_deli_BEH.png", plot=plot_deli_BEH, width = 15, height = 12, units = "cm", dpi = 3000)

# Plot time frozen L. guichenoti
plot_guich_BEH <- ggplot(guich_stressor, aes(x = Day, y = log(lat_to_move+1), fill=interaction(cort,temp))) +  
  geom_boxplot(outlier.shape = NA) +
  ylim(0, 8) +
  scale_fill_manual(values = c("CORT.Cold"="black", "Control.Cold"="grey", "CORT.Hot"="orange2", "Control.Hot"="moccasin"),
    labels=c("CORT-Cold (n=10)", "Control-Cold (n=7)", "CORT-Hot (n=11)", "Control-Hot (n=10)")
  ) +
  labs(y = "Time frozen (s)", x = "Day", fill="Treatment") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 18, family = "sans"),  
    axis.text = element_text(size = 12, family = "sans"),  
    legend.title = element_text(size = 14, family = "sans"), 
    legend.text = element_text(size = 12, family = "sans")  
  )
print(plot_guich_BEH)
ggsave("./output/figures/fig_guich_BEH.png", plot=plot_guich_BEH, width = 15, height = 12, units = "cm", dpi = 3000)

```



## Discussion


## References

## Supplementary material

_Table **S1**. Estimates of each predictor for each variable modelled for L. delicata.  Lower and upper CI, and pMCMC values test the hypothesis that the estimate is different from 0. In bold, the values that are significant at pMCMC < 0.05._

```{r, tablesummary_deli}
#| label: tablesummary_deli
#
# Table defaults
set_flextable_defaults(
 font.family = "Times New Roman",
 font.size = 10)
# Make Table
table_summ_deli <- flextable(deli_post) %>%
  flextable::compose(i = 1, j = 1, value = as_paragraph("Variable"), part = "header") %>% # Change the first column header
  align(align = "center", j = c(3:6), part = "body") %>%
  align(align = "center", j = c(1:6), part = "header") %>%
  bold(~`pMCMC` < 0.05, j = c("pMCMC", "CI_upper", "CI_lower", "Mean", "Predictor"),
       bold = TRUE) %>%  # Bold when PMCMC is "<0.05"
  bold(~`pMCMC` <0.001, j = c("pMCMC", "CI_upper", "CI_lower", "Mean", "Predictor")) %>%  # Bold when PMCMC is "<0.001"
  flextable::compose(i = c(2:5,7:10,12:15,17:20), j = 1, value = as_paragraph(""), part = "body") %>% # To remove some of the values in the first column
  flextable::hline(i = c(5,10,15), part = "body") %>% # Add horizontal lines
  autofit()
#
table_summ_deli
```

```{r, results='asis', echo=FALSE}
cat("\\newpage")
```

_Table **S1**. Estimates of each predictor for each variable modelled for L. delicata.  Lower and upper CI, and pMCMC values test the hypothesis that the estimate is different from 0. In bold, the values that are significant at pMCMC < 0.05._

```{r, tablesummary_guich}
#| label: tablesummary_guich
#
# Table defaults
set_flextable_defaults(
 font.family = "Times New Roman",
 font.size = 10)
# Make Table
table_summ_guich <- flextable(guich_post) %>%
  flextable::compose(i = 1, j = 1, value = as_paragraph("Variable"), part = "header") %>% # Change the first column header
  align(align = "center", j = c(3:6), part = "body") %>%
  align(align = "center", j = c(1:6), part = "header") %>% 
  bold(~`pMCMC` < 0.05, j = c("pMCMC", "CI_upper", "CI_lower", "Mean", "Predictor"),
       bold = TRUE) %>%  # Bold when PMCMC is "<0.05"
  bold(~`pMCMC` <0.001, j = c("pMCMC", "CI_upper", "CI_lower", "Mean", "Predictor")) %>%  # Bold when PMCMC is "<0.001"
  flextable::compose(i = c(2:5,7:10,12:15,17:20), j = 1, value = as_paragraph(""), part = "body") %>% # To remove some of the values in the first column
  flextable::hline(i = c(5,10,15), part = "body") %>% # Add horizontal lines
  autofit()
#
table_summ_guich
```

