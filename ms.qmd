---
docx: 
reference-doc: "./bib/tmpl.docx"
bibliography: "./bib/refs.bib"
execute:
  echo: false
  error: false
  cache: false
  warning: false
crossref:  
  fig-title: Figure    # (default is "Figure")
  title-delim: —     # (default is ":")
  fig-prefix: Fig.   # (default is "Figure")
  tbl-prefix: Tab.   # (default is "Table")
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup

pacman::p_load(tidyverse, flextable, emmeans, DHARMa, brms, here, ggplot2, lme4, zoo, lmerTest, MASS)

source(here("R", "func.R"))
```

## Introduction

Hypothesis PRESENTATION:

Both temperature and CORT influence the development of proactive-reactive personality types, associated at the same time with different HPA axis reactivity. In this sense, both increases in prenatal CORT and lower temperatures are related to more reactive individuals, which are more sensitive to stressors. As such, I predict individuals incubated at low temperature and/or treated with CORT to be more reactive, and thus to spent more time frozen after chasing them and not coming out from the shelter. At the same time I expect these individuals to have increased phisiological costs (mass lost) when submitted to a 'chronic' stressor.


## Methods

### Subjects

We used two species of skinks, the common garden skink (*Lampropholis guichenoti*) and the rainbow skink or delicate skink (*L. delicata*). These are oviparous, generalist, small (∼35--55 mm snout-vent length (SVL)) lizards that are sympatric in suburban areas throughout south-eastern Australia ([@chapple_know_2011]). Both species have similar breeding periods, but reproductive output in *L. delicata* is one clutch of 1 to 6 eggs per season, while *L. guichenoti* lays 1-5 eggs per clutch, and usually two clutches per season ([@chapple_know_2011]; [@chapple_biology_2014]). This difference in reproductive output through the breeding season may involve different degree of sensitivity to maternal effects and its interaction with other aspects of early environment.

### Subjects treatments, collection, and housing

The skinks used in our experiments came from a breeding colony established in the lab since 2019. The colony is compound by a total total of 270 adults of *L. delicata* and 180 adults of *L.* guichenoti that are housed in big containers (41.5 L x 30.5 W x 21 H cm) with six lizards (2 males and 4 females) per enclosure. These enclosures are provided with non-stick matting, shelter, and several small water dishes. Lizards are given water daily, and fed approx. 40 mid-size crickets (*Acheta domestica*) per enclosure three days a week. Crickets are dusted with calcium weekly and multivitamin and calcium biweekly. Room temperatures are set to 22-24 Celsius, and warm side of enclosures is usually at 32 Celsius; but to ensure a temperature gradient, we employ a heat chord and a heat lamp following a 12 h light:12 h dark cycle.

Eggs were collected between mid-October 2022 to the end of February 2023. We placed in the commonal enclosure small boxes (12.5 L x 8.3 W x 5 H cm) with moist vermiculite inside so females had a place to lay the eggs. Three times a week, we checked these boxes for the presence of eggs. Once a clutch was found, we measured eggs' length and width with a digital caliper to the nearest 0.1 mm and mass with a (OHAUS, Model spx123) digital scale ± 0.001g error. To test the effect of prenatal CORT and temperature, we manipulated CORT levels in eggs and then incubated them at one of two temperature regimes (‘Cold’ – 23ºC ± 3ºC or ‘Hot’ – 30ºC ± 3ºC) in a 2x2 factorial design. CORT was increased by topical aplication of a solution of CORT dissolved in 70% Ethanol and 30% DMSO (vehicle) at concentrations 2 standard deviations above the mean natural hormone concentration (non-published data); while a 'Control' group received an equal volume of the vehicle. Then, eggs were placed in individual cups (80 mL) with moist vermiculite (12 parts water to 4 parts vermiculite) covered with cling wrap to retain moisture, and were left in LATWIT 2X5D-R1160 incubators at two different temperatures ('Cold' or 'Hot') until hatchling.

INSERT Fig 1

The incubators were checked three times a week for hatchlings. When hatchligns were found, we recorded Snout-vent length (SVL) and tail length (TL) with a rule to the nearest mm while mass was measured with a (OHAUS, Model spx123) digital scale ± 0.001g error. Then, hatchlings were enclosed in individual tubs (18.7L x 13.2W x 6.3H cm) provided with non-stick matting and a small water dish. During this period, they were sprayed water every day and received 3-6 small *A. domestica* crickets three times a week. All care otherwise follows similar protocols to adults (see above). 


### Experimental arena and design
The experiments were done:
The sample size was:
The experimental arena was:
The experimental design was:
The lizards used in this experiment were subjected before to a personality test and two types of learning tasks. These experiments are not considered stresful, and, as such, we do not expect them to affect the results of the present study. However, we left three weeks between those experiments and the present one to control for possible effects of the previous tests.
After 3 months, we measured again SVL, TL, and mass of the juveniles and then they were moved to the experimental arena (see below).
The day before starting the experiment, lizards were measured again, and then moved to a new enclosure the same size and conditions before, but in the room where the CCTV system is held () experimental arena (Fig. 1c) for acclimatation. The arenas were individual medium size (41 L x 29.7 W x 22 H cm) plastic containers with a shelter (9 L x 6 W x 1.5 H cm) on one of the extremes and a water dish on the other. These new enclosures were placed in two rooms in 7 different racks associated to 7 different CCTV systems (device model DVR-HP210475) that allowed us to record their behaviour during the experiment (see details below). The number of lizards per species and treatment in each rack was counterbalanced to control for any effect of the room or the position of the lizard in the rack. During acclimatation and all the experiment, lizards were fed with only one cricket per day dusted with calcium and multivitamin (see protocol below), and water was supplied *ad libitum.* We provided a temperature gradient by means of a heat cord and heat lamps in a 12 h light: 12 h dark cycle. The rooms temperature was set to between 22-24 Celsius. 

### CORT measurement and validation

### Statistical analyses

## Results

```{r, dataload}
#| label: dataload
#| echo: false
#| warning: false
 
# Load data
	data  <-  read.csv("./data/Stressor.csv")
```

```{r, dataexplore}
#| label: dataexplore
#| echo: false
#| warning: false

# Divide Treatment in CORT and Temperature
data <- data %>%
      mutate(temp = gsub("[AB]_", "", trt),
          cort = gsub("_[2][38]", "", trt))  %>% 
  data.frame()

# MASS
# Create new database to analyse increases in mass (i.e. having mass after and before in different columns)
data_2 <- pivot_wider(data, id_cols=c(lizard,temp,cort,species,food_ingested), names_from = Day, values_from = mass)
data_2 <- data_2 %>% mutate(delta_mass=After-Before) 
data_2 <- data_2 %>% mutate(rescaled_delta_mass = delta_mass - min(delta_mass) + 1)
write.csv(data_2, "./data/Stressor_2.csv")
# Transform mass into mg in new database
data_2$mass <- data$mass*1000

# Estimate mass increase

# Split data by species in new database
deli_stressor_2 <- data_2 %>% filter (species == "delicata")
guich_stressor_2 <- data_2 %>% filter (species == "guichenoti")

# Explore distribution of mass increase
  # A) L.deli
plot_mass <- ggplot(deli_stressor_2, aes(x = mass, fill = interaction(as.factor(temp),as.factor(cort), sep="_"))) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 30, color = "black") +
  scale_fill_manual(values = c("28_A" = "red", "23_A" = "blue", "28_B" = "salmon", "23_B" = "lightblue")) +
  labs(x = "Mass", y = "Density", fill = "Temperature ~ CORT") +
  theme_minimal() +
  facet_grid(cort*temp~Day, scales = "free_y")
print(plot_mass)

mass_normal_test<-by(deli_stressor_2$mass, interaction (deli_stressor$cort, deli_stressor$temp, deli_stressor$Day), function(x) shapiro.test((x)))
print(mass_normal_test)

  #B) L.guich
plot_mass <- ggplot(guich_stressor_2, aes(x = mass, fill = interaction(as.factor(temp),as.factor(cort), sep="_"))) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 30, color = "black") +
  scale_fill_manual(values = c("28_A" = "red", "23_A" = "blue", "28_B" = "salmon", "23_B" = "lightblue")) +
  labs(x = "Mass", y = "Density", fill = "Temperature ~ CORT") +
  theme_minimal() +
  facet_grid(cort*temp~Day, scales = "free_y")
print(plot_mass)

mass_normal_test<-by(guich_stressor$mass, interaction (guich_stressor$cort, guich_stressor$temp, guich_stressor$Day), function(x) shapiro.test((x)))
print(mass_normal_test)



# BEHAVIOUR
# Split data by species in original database
deli_stressor <- data %>% filter (species == "delicata")
guich_stressor <- data %>% filter (species == "guichenoti")
# Explore distribution of latency to move/time frozen
  # A) L. deli
plot_freeze <- ggplot(deli_stressor, aes(x = log(lat_to_move+1), fill = interaction(as.factor(temp),as.factor(cort), sep="_"))) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 30, color = "black") +
  scale_fill_manual(values = c("28_A" = "red", "23_A" = "blue", "28_B" = "salmon", "23_B" = "lightblue")) +
  labs(x = "Mass", y = "Density", fill = "Temperature ~ CORT") +
  theme_minimal() +
  facet_grid(cort*temp~Day, scales = "free_y")
print(plot_freeze)

freeze_normal_test<-by(deli_stressor$lat_to_move, interaction (deli_stressor$cort, deli_stressor$temp, deli_stressor$Day), function(x) shapiro.test(log(x+1)))
print(freeze_normal_test)

 #B) L.guich
plot_freeze <- ggplot(guich_stressor, aes(x = log(lat_to_move+1), fill = interaction(as.factor(temp),as.factor(cort), sep="_"))) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 30, color = "black") +
  scale_fill_manual(values = c("28_A" = "red", "23_A" = "blue", "28_B" = "salmon", "23_B" = "lightblue")) +
  labs(x = "Mass", y = "Density", fill = "Temperature ~ CORT") +
  theme_minimal() +
  facet_grid(cort*temp~Day, scales = "free_y")
print(plot_freeze)

freeze_normal_test<-by(guich_stressor$lat_to_move, interaction (guich_stressor$cort, guich_stressor$temp, guich_stressor$Day), function(x) shapiro.test(log(x+1)))
print(freeze_normal_test)

```


```{r, models1}
#| label: models1
#| echo: false
#| warning: false

# Generalized Mixed Models delicata
GMM_deli <- glmer(FC_associative ~ Associative_Trial*temp*cort + group*Associative_Trial + (1 + Associative_Trial|lizard_id), data = deli_associative, family = binomial(link = "logit"))
summary(GMM_deli)

emmeans(GMM_deli, pairwise ~ temp*Associative_Trial)
emmeans(GMM_deli, pairwise ~ cort*Associative_Trial)

# Generalized Mixed Models guichenoti
GMM_guich <- glmer(FC_associative ~ Associative_Trial*temp*cort + group*Associative_Trial + (1 + Associative_Trial|lizard_id), data = guich_associative, family = binomial(link = "logit"))
summary(GMM_guich)

emmeans(GMM_guich, pairwise ~ temp*Associative_Trial)
emmeans(GMM_guich, pairwise ~ cort*Associative_Trial)
emmeans(GMM_guich, pairwise ~ temp*cort*Associative_Trial)

```

```{r, models2}
#| label: models2
#| echo: false
#| warning: false

# Bayesian model delicata
  deli_mod <- brm(FC_associative ~ cort*temp*Associative_Trial + group*Associative_Trial + (1 + Associative_Trial|lizard_id), data = deli_associative, family = bernoulli(link = "logit"), chains = 4, cores = 4, iter = 2000, warmup = 1000, control = list(adapt_delta = 0.99))
  summary(deli_mod)
  plot(deli_mod)

# Bayesian model guichenoti
  guich_mod <- brm(FC_associative ~ cort*temp*Associative_Trial + group*Associative_Trial + (1 + Associative_Trial|lizard_id), data = guich_associative, family = bernoulli(link = "logit"), chains = 4, cores = 4, iter = 2000, warmup = 1000, control = list(adapt_delta = 0.99))
  summary(deli_mod)
# R2
bayes_R2(mod)

# Extract posteriors
posterior <- posterior_samples(mod, pars = "^b")
plyr::ldply(lapply(posterior, mean))
plyr::ldply(lapply(posterior, function(x) quantile(x, c(0.025, 0.975))))
temp23 <- c(posterior[,"b_Intercept"], (posterior[,"b_Intercept"]+ posterior[,"b_trtB_23"]))
temp28 <- c((posterior[,"b_Intercept"] + posterior[,"b_trtB_28"]), posterior[,"b_trtB_23"])

pmcmc(temp23 - temp28)
dharma(GMM_deli2)


```

```{r, plots}
#| label: plots
#| echo: false
#| warning: false
 
# Plot delicata
plot_deli <- ggplot(deli_associative, aes(x = Associative_Trial, y = FC_associative, color=interaction(cort,temp))) +  
  geom_smooth(method = "glm", formula = y ~ x, method.args = list(family = "binomial"),na.action = na.exclude) +
  facet_grid(as.factor(deli_associative$group)) + 
  labs(y = "Colour Association Task", x = "Trial")  
print(plot_deli)

# Plot guichenoti
plot_guich <- ggplot(guich_associative, aes(x = Associative_Trial, y = FC_associative, color=interaction(cort,temp))) +  
  geom_smooth(method = "glm", formula = y ~ x, method.args = list(family = "binomial"),na.action = na.exclude) +
  facet_grid(as.factor(guich_associative$group)) + 
  labs(y = "Colour Association Task", x = "Trial") 
print(plot_guich)
```




We calculated $R^2$ as follows

$$
R^2 = \frac{SS_{reg}}{SS_{tot}}
$$ {#eq-r2}

@eq-r2

```{r, fig1}
#| label: fig-fig1
#| fig-cap: "Activity budget of the focal group of chacma baboons (Papio ursinus) at the Cape Peninsula, South Africa, during the study period. The data are presented as the mean percentage of time spent in each activity category per hour (± SE)."

data %>% ggplot(aes(x = Lizard_id))  + geom_histogram()


```

We have a total of `r length(unique(data$Lizard_id))`

```{r,tb1}
#| label: tbl-tb1
#| tbl-cap: "Summary of the data"

tab <- data %>% 
  group_by(Lizard_id) %>% 
  summarise(
    n = n()
  ) 
flextable(tab[2:3,])
```

# References